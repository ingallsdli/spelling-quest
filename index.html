<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lincoln's Spelling Quest</title>

<style>
  :root{
    --bg:#0b1220; --text:#e9eefc; --muted:#a9b6da;
    --ok:#33d17a; --bad:#ff5c5c;
    --btn:#1a2644; --btn2:#22335c;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: radial-gradient(1200px 600px at 50% -20%, #1a2c5e 0%, var(--bg) 60%);
    color:var(--text);
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
  }
  .card{
    width:min(980px,100%);
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    border:1px solid rgba(255,255,255,0.10);
    border-radius:18px;
    padding:16px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.35);
  }
  h1{margin:0 0 6px; font-size:28px;}
  .sub{color:var(--muted); margin:0 0 10px; line-height:1.35; font-weight:600;}
  .top{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px;}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    background: rgba(44,97,255,0.16);
    border:1px solid rgba(44,97,255,0.25);
    padding:8px 12px; border-radius:999px; font-weight:1000;
  }
  .progress{
    height:12px; border-radius:999px;
    background: rgba(255,255,255,0.10);
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.10);
    flex:1; min-width:220px;
  }
  .bar{
    height:100%;
    background: linear-gradient(90deg, #2c61ff, #9b7bff);
    width:0%;
    transition: width 220ms ease;
  }
  button{
    border:0; cursor:pointer;
    background: var(--btn);
    color: var(--text);
    padding:14px 16px;
    border-radius:14px;
    font-size:18px;
    font-weight:1000;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.10);
    user-select:none;
  }
  button.primary{background: linear-gradient(180deg, #2c61ff, #2a4bcc);}
  button.alt{background: var(--btn2);}
  button.good{background: rgba(51,209,122,0.20); box-shadow: inset 0 0 0 1px rgba(51,209,122,0.30);}
  button.warn{background: rgba(255,92,92,0.18); box-shadow: inset 0 0 0 1px rgba(255,92,92,0.28);}

  .inputWrap{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  input{
    flex:1 1 320px;
    padding:16px 14px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.16);
    background: rgba(0,0,0,0.22);
    color: var(--text);
    font-size:22px;
    font-weight:1000;
    letter-spacing: .8px;
  }
  .msg{
    margin-top:12px;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.10);
    background: rgba(0,0,0,0.18);
    min-height:56px;
    display:flex; align-items:center;
    color: var(--muted);
    line-height:1.3;
    font-weight:900;
  }
  .msg.ok{color:#c9ffe1; border-color: rgba(51,209,122,0.35); background: rgba(51,209,122,0.10);}
  .msg.bad{color:#ffd2d2; border-color: rgba(255,92,92,0.35); background: rgba(255,92,92,0.10);}

  .kbd{
    margin-top:14px;
    display:grid;
    grid-template-columns: repeat(10, minmax(0,1fr));
    gap:10px;
  }
  .k{
    padding:16px 0;
    text-align:center;
    border-radius:14px;
    background: rgba(255,255,255,0.08);
    border:1px solid rgba(255,255,255,0.10);
    font-weight:1000;
    font-size:20px;
  }
  .kbd .wider{grid-column: span 3;}
  .tiny{font-size:12px;color:rgba(233,238,252,.7);margin-top:10px;line-height:1.35;}

  /* Celebration overlay */
  #celebration{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    background: radial-gradient(900px 600px at 50% 30%, rgba(255,255,255,0.10), rgba(0,0,0,0.78)),
                linear-gradient(135deg, #2c61ff, #9b7bff);
    z-index:9999;
    overflow:hidden;
    padding:24px;
    text-align:center;
  }
  #celebrationText{
    color:white;
    font-weight:1000;
    font-size: clamp(32px, 6vw, 80px);
    text-shadow: 0 0 20px rgba(0,0,0,0.45);
    animation: flash 0.9s infinite;
    line-height:1.05;
  }
  #celebrationSub{
    margin-top:12px;
    color: rgba(255,255,255,0.92);
    font-size: clamp(16px, 2.2vw, 28px);
    font-weight:900;
    text-shadow: 0 0 14px rgba(0,0,0,0.35);
  }
  #playAgainBtn{
    margin-top:18px;
    font-size:20px;
    padding:14px 18px;
    border-radius:16px;
    background: rgba(51,209,122,0.22);
    box-shadow: inset 0 0 0 1px rgba(51,209,122,0.35);
  }
  @keyframes flash{
    0% { transform: scale(1.00); filter: brightness(1.0); }
    50%{ transform: scale(1.04); filter: brightness(1.15); }
    100%{ transform: scale(1.00); filter: brightness(1.0); }
  }
  .confettiPiece{
    position:fixed;
    width:10px;
    height:10px;
    top:-20px;
    z-index:9998;
    border-radius:2px;
    opacity:0.95;
    will-change: transform;
  }
</style>
</head>

<body>
<div class="card">
  <h1>Lincoln's Spelling Quest</h1>
  <p class="sub">Audio-only spelling. Listen to the word. Type it (or tap letters). Get <b>10 correct</b> to finish your lesson.</p>

  <div class="top">
    <span class="pill">‚≠ê Correct: <span id="count">0</span>/10</span>
    <div class="progress"><div class="bar" id="bar"></div></div>
    <button class="primary" onclick="startNext()">‚ñ∂ Start / Next Word</button>
    <button class="alt" onclick="testVoice()">Test Voice</button>
  </div>

  <div class="inputWrap">
    <input id="answer" placeholder="Type here‚Ä¶" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <button class="alt" onclick="hearAgain()">üîä Hear Again</button>
    <button class="alt" onclick="giveHint()">üí° Hint</button>
    <button class="good" onclick="checkAnswer()">‚úÖ Check</button>
    <button class="warn" onclick="clearBox()">‚å´ Clear</button>
  </div>

  <div class="msg" id="msg">Tap <b>Start</b> To Begin.</div>
  <div class="kbd" id="kbd"></div>

  <div class="tiny">
    BUILD: <span id="buildStamp"></span><br/>
    Live URL: <b>https://ingallsdli.github.io/spelling-quest/</b><br/>
    After committing, open: <b>https://ingallsdli.github.io/spelling-quest/?v=new</b> then press <b>Ctrl + F5</b>.
  </div>
</div>

<!-- Celebration overlay -->
<div id="celebration">
  <div id="celebrationText">GREAT JOB LINCOLN!!!!</div>
  <div id="celebrationSub">You finished your lesson.</div>
  <button id="playAgainBtn" class="good" onclick="playAgain()">üéâ Play Again (New Lesson)</button>
</div>

<script>
/* ===== Build stamp ===== */
document.getElementById("buildStamp").textContent = "2026-02-20-reveal-after-2-faster-voice-v9";

/* ===== Settings ===== */
var REQUIRED_CORRECT = 10;

/* #1 Voice tuning: a bit faster + less robotic */
var RATE = 0.82;     // was 0.71
var PITCH = 1.02;    // was 1.08

/* Difficulty mix per lesson */
var DIFFICULTY_MIX = { easy: 4, medium: 4, hard: 2 };

/* Praise variety */
var PRAISE = [
  "Great job, Lincoln!",
  "You're rocking now, Lincoln!",
  "Keep up the great work, Lincoln!",
  "Awesome spelling, Lincoln!",
  "Nice work, Lincoln!",
  "Way to go, Lincoln!",
  "You‚Äôre getting stronger, Lincoln!"
];

/* ===== Build a 500-word bank (guaranteed) ===== */
function buildWordBank(text, extras, target){
  var seen = {};
  var out = [];

  function addWord(w){
    w = (w || "").toLowerCase().replace(/[^a-z]/g,'').trim();
    if (!w) return;
    if (w.length < 2 || w.length > 10) return;
    if (!seen[w]){
      seen[w]=1;
      out.push({ w: w });
    }
  }

  var parts = (text || "").toLowerCase().split(/[\s,]+/);
  for (var i=0;i<parts.length;i++) addWord(parts[i]);

  var extraParts = (extras || "").toLowerCase().split(/[\s,]+/);
  for (var j=0;j<extraParts.length;j++) addWord(extraParts[j]);

  if (out.length < target){
    console.warn("Word bank produced only", out.length, "words; expected", target);
  }
  return out.slice(0, Math.min(target, out.length));
}

/* Big common-word source + extra fallback words */
var WORD_BANK_TEXT = `
the of to and a in is it you that he was for on are with as his they be at one have this from or had by word but what some
we can out other were all there when up use your how said an each she which do their time if will way about many then them
write would like so these her long make thing see him two has look more day could go come did number sound no most people my
over know water than call first who may down side been now find any new work part take get place made live where after back
little only round man year came show every good me give our under name very through just form sentence great think say help
low line turn cause much mean before move right boy old too same tell does set three want air well also play small end put home
read hand large spell add even land here must big high such follow act why ask men change went light kind off need house picture
try us again animal point mother world near build self earth father head stand own page should country found answer school grow
study still learn plant cover food sun four between state keep eye never last let thought city tree cross farm hard start might
story saw far sea draw left late run while press close night real life few north open seem together next white children begin got
walk example ease paper group always music those both mark often letter until mile river car feet care second book carry took science
eat room friend began idea fish mountain stop once base hear horse cut sure watch color face wood main enough plain girl usual young
ready above ever red list though feel talk bird soon body dog family direct leave song measure door product black short numeral class
wind question happen complete ship area half rock order fire south problem piece told knew pass since top whole king space heard best
hour better true during hundred five remember step early hold west ground interest reach fast verb sing listen six table travel less
morning ten simple several vowel toward war lay against pattern slow center love person money serve appear road map rain rule govern
pull cold notice voice unit power town fine certain fly fall lead cry dark machine note wait plan figure star box noun field rest
correct able pound done beauty drive stood contain front teach week final gave green quick develop ocean warm free minute strong special
mind behind clear tail produce fact street inch multiply nothing course stay wheel force blue object decide surface deep moon island foot
system busy test record boat common gold possible plane stead dry wonder laugh thousand ago ran check game shape yes miss brought heat snow
tire bring sit perhaps fill east paint language among grand ball yet wave drop heart present heavy dance engine position arm wide sail
material size vary settle speak weight general ice matter circle pair include divide syllable felt pick sudden count square reason length
represent art subject region energy hunt probable bed brother egg ride cell believe fraction forest race window store summer train sleep
prove lone leg exercise wall catch mount wish sky board joy winter sat written wild instrument kept glass grass cow job edge sign visit
past soft fun bright gas weather month million bear finish happy hope flower strange gone jump baby eight village meet root buy raise solve
metal whether push seven paragraph third shall held hair describe cook floor either result burn hill safe cat century consider type law bit
coast copy phrase silent tall sand soil roll finger industry value fight lie beat excite natural view sense ear else quite broke case middle
son lake moment scale loud spring observe child straight nation dictionary milk speed method organ pay age section dress cloud surprise quiet
stone tiny climb cool design poor lot bottom key iron single stick flat twenty skin smile hole trade trip office receive row mouth exact symbol
die least trouble shout except seed tone join suggest clean break lady yard rise bad blow oil blood touch grew cent mix team wire cost lost
brown wear garden equal sent choose fell fit flow fair bank collect save control gentle woman captain practice separate difficult doctor please
protect noon whose locate ring character insect caught period indicate radio spoke atom human history effect electric expect crop modern element
hit student corner party supply bone rail imagine provide agree capital chair danger fruit rich thick soldier process operate guess necessary sharp
wing create neighbor wash bat crowd corn compare poem string bell depend meat rub tube famous dollar stream fear sight thin triangle planet hurry chief
colony clock mine tie enter major fresh search send yellow gun allow print dead spot desert suit current lift rose continue block chart hat sell success
subtract event particular deal swim term opposite wife shoe shoulder spread arrange camp invent cotton born determine quart nine truck noise level chance
gather shop stretch throw shine property column molecule select wrong gray repeat require broad prepare salt nose plural anger claim continent oxygen sugar
death pretty skill women season solution magnet silver thank branch match suffix especially fig afraid huge sister steel discuss forward similar guide
experience score apple bought led pitch coat mass card band rope slip win dream evening condition feed tool total basic smell valley double seat arrive
master track parent shore division sheet substance favor connect post spend chord glad original share station dad bread charge proper bar offer segment slave
duck instant market degree populate chick dear enemy reply drink occur support speech nature range steam motion path liquid log meant quotient teeth shell neck
`;

var EXTRA_WORDS = `
able about above across act add after again air all almost along also always animal another answer any apple area around ask away baby back bake ball bank base
bath beach bear beat became because become bed been before began begin behind being below best better big bird black block boat body book born both box boy branch
bread break bright bring broke brown build built busy buy cake call came can car card care carry case cat catch cause cent chair change check child children city
class clean clear climb clock close coat cold color come common company could country course cover cow cry cut dad daily dance dark day dear decide deep did different
dish do does dog done door down draw dream dress drink drive drop dry each early earth east easy eat end enough even ever every example eye face fact fall family
far farm fast father feel feet few field fight fill find fine fire first fish five floor flower fly follow food foot forest form found four free friend front full fun
game garden gave general get girl give glad glass go gold gone good got great green ground group grow had half hand happen happy hard has hat have head hear heard
heart help here high hill hold home horse hot hour house how huge idea if important into island item job join just keep kept key kind king knew know lake land large
last late laugh lead learn leave left leg less let letter life light like line list little live long look love low lucky lunch made make man many map mark may meal mean
measure meet men might mile milk mind minute miss money month moon more morning most mother move much music must name near need never new next night north note nothing
now number off often oil old once one only open order other our out over own page paint pair paper park part party pass past pay people perhaps person pet picture piece
place plan plant play please poem point poor possible post power practice pretty problem pull put quick quiet rain ran read ready real record red remember rest rich right
river road rock room round rule run said same sand sat save saw say school sea second see seem seen self send set seven several shall she ship shoes shop short should
show side simple sing sister sit six sky sleep slow small smile snow so some someone something song soon sound south special spell spring start state stay step still stop
story street strong study such sun sure take talk tall teacher team tell ten test than thank that their them then there these they thing think third this those though thought
three through time today together told too took town tree tried try turn two type under until up us use usually very visit voice walk want warm was watch water way well
went were west what when where which while white who why will wind winter with within woman word work world would write wrong year yes yet young your
`;

var WORD_BANK = buildWordBank(WORD_BANK_TEXT, EXTRA_WORDS, 500);

/* ===== Difficulty selection ===== */
function difficultyOfWord(w){
  var n = (w || "").length;
  if (n <= 4) return "easy";
  if (n <= 6) return "medium";
  return "hard";
}
function sampleWithoutReplacement(arr, n){
  var a = arr.slice();
  for (var i=a.length-1;i>0;i--){
    var j = Math.floor(Math.random()*(i+1));
    var t=a[i]; a[i]=a[j]; a[j]=t;
  }
  return a.slice(0, Math.min(n, a.length));
}
function buildLessonWithDifficultyMix(bank, mix){
  var easy=[], medium=[], hard=[];
  for (var i=0;i<bank.length;i++){
    var d = difficultyOfWord(bank[i].w);
    if (d==="easy") easy.push(bank[i]);
    else if (d==="medium") medium.push(bank[i]);
    else hard.push(bank[i]);
  }

  var chosen = [];
  var used = {};

  function addGroup(groupArr, count){
    var picks = sampleWithoutReplacement(groupArr, count);
    for (var k=0;k<picks.length;k++){
      var w = picks[k].w;
      if (!used[w]){
        used[w]=1;
        chosen.push(picks[k]);
      }
    }
  }

  addGroup(easy, mix.easy);
  addGroup(medium, mix.medium);
  addGroup(hard, mix.hard);

  var total = mix.easy + mix.medium + mix.hard;
  if (chosen.length < total){
    var rest=[];
    for (var r=0;r<bank.length;r++){
      if (!used[bank[r].w]) rest.push(bank[r]);
    }
    var needed = total - chosen.length;
    var fill = sampleWithoutReplacement(rest, needed);
    for (var f=0;f<fill.length;f++) chosen.push(fill[f]);
  }
  return chosen;
}

/* ===== State ===== */
var VOICES = [];
var lessonWords = [];
var lastLessonWords = [];
var passed = {};
var skipped = {};
var usedLesson = {};
var passedCount = 0;
var current = null;
var attempts = 0;
var hintLevel = 0;
var finished = false;

/* ===== Helpers ===== */
function $(id){ return document.getElementById(id); }
function setMsg(html, cls){
  var m = $("msg");
  m.className = "msg" + (cls ? (" " + cls) : "");
  m.innerHTML = html;
}
function updateProgress(){
  $("count").textContent = String(passedCount);
  $("bar").style.width = (Math.min(100, (passedCount / REQUIRED_CORRECT) * 100)) + "%";
}
function normalize(x){
  return (x || "").toLowerCase().replace(/[^a-z]/g,'').trim();
}
function randFrom(arr){
  return arr[Math.floor(Math.random() * arr.length)];
}
function arraysEqual(a,b){
  if (a.length !== b.length) return false;
  for (var i=0;i<a.length;i++) if (a[i] !== b[i]) return false;
  return true;
}
function sortedWords(objs){
  var list = [];
  for (var i=0;i<objs.length;i++) list.push(objs[i].w);
  list.sort();
  return list;
}

/* ===== Voice ===== */
function loadVoices(){
  try{ VOICES = speechSynthesis.getVoices() || []; } catch(e){ VOICES = []; }
}
speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

function pickFemaleVoice(){
  // Prefer local/offline female voices if available
  var preferred = ["Zira","Aria","Jenny"];
  for (var p=0;p<preferred.length;p++){
    for (var i=0;i<VOICES.length;i++){
      var v = VOICES[i];
      var name = (v.name || "");
      if (name.indexOf(preferred[p]) !== -1 && v.localService) return v;
    }
  }
  for (var p2=0;p2<preferred.length;p2++){
    for (var j=0;j<VOICES.length;j++){
      var v2 = VOICES[j];
      var name2 = (v2.name || "");
      if (name2.indexOf(preferred[p2]) !== -1) return v2;
    }
  }
  for (var k=0;k<VOICES.length;k++){
    var lang = (VOICES[k].lang || "");
    if (lang.indexOf("en") === 0) return VOICES[k];
  }
  return VOICES.length ? VOICES[0] : null;
}

function speak(text, after, afterDelayMs){
  var u = new SpeechSynthesisUtterance(text);
  var v = pickFemaleVoice();
  if (v) u.voice = v;
  u.lang = "en-US";

  // Slight natural variation (tiny jitter) to sound less robotic
  var rateJ = (Math.random()*0.04 - 0.02);   // ¬±0.02
  var pitchJ = (Math.random()*0.04 - 0.02);  // ¬±0.02
  u.rate = Math.max(0.74, Math.min(0.92, RATE + rateJ));
  u.pitch = Math.max(0.90, Math.min(1.12, PITCH + pitchJ));
  u.volume = 1;

  if (after){
    u.onend = function(){ setTimeout(after, afterDelayMs || 0); };
    u.onerror = function(){ setTimeout(after, afterDelayMs || 0); };
  }

  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ===== Confetti ===== */
function clearConfetti(){
  var pieces = document.querySelectorAll(".confettiPiece");
  for (var i=0;i<pieces.length;i++) pieces[i].remove();
}
function launchConfetti(){
  clearConfetti();
  var colors = ["#ff3b30","#ffcc00","#34c759","#007aff","#af52de","#ff9500","#00c7be"];
  var count = 200;

  for(var i=0;i<count;i++){
    var piece = document.createElement("div");
    piece.className = "confettiPiece";
    piece.style.background = colors[Math.floor(Math.random()*colors.length)];
    piece.style.left = (Math.random()*100) + "vw";
    piece.style.width = (6 + Math.random()*10) + "px";
    piece.style.height = (6 + Math.random()*14) + "px";
    piece.style.borderRadius = (Math.random() < 0.35) ? "50%" : "2px";
    document.body.appendChild(piece);

    var drift = (Math.random()*40 - 20);
    var fall = (100 + Math.random()*30);

    (function(el, d, f){
      var anim = el.animate([
        { transform:"translateY(0) translateX(0) rotate(0deg)", opacity:1 },
        { transform:"translateY(" + f + "vh) translateX(" + d + "vw) rotate(" + (720 + Math.random()*720) + "deg)", opacity:1 }
      ],{
        duration: 2200 + Math.random()*1200,
        easing: "cubic-bezier(.2,.8,.2,1)"
      });
      anim.onfinish = function(){ el.remove(); };
    })(piece, drift, fall);
  }
}

/* ===== Ensure next lesson differs from last ===== */
function buildNewLessonDifferentFromLast(){
  if (WORD_BANK.length <= REQUIRED_CORRECT){
    return buildLessonWithDifficultyMix(WORD_BANK, DIFFICULTY_MIX).slice(0, WORD_BANK.length);
  }

  var tries = 0;
  while (tries < 25){
    var newSet = buildLessonWithDifficultyMix(WORD_BANK, DIFFICULTY_MIX);
    var newSorted = sortedWords(newSet);
    var lastSorted = lastLessonWords.slice().sort();
    if (!arraysEqual(newSorted, lastSorted)){
      return newSet;
    }
    tries++;
  }

  var forced = buildLessonWithDifficultyMix(WORD_BANK, DIFFICULTY_MIX);
  forced.reverse();
  return forced;
}

/* ===== Replacement word after reveal+skip ===== */
function addReplacementWord(){
  var candidates = [];
  for (var i=0;i<WORD_BANK.length;i++){
    var w = WORD_BANK[i].w;
    if (!usedLesson[w]) candidates.push(WORD_BANK[i]);
  }
  if (!candidates.length) return;
  var next = candidates[Math.floor(Math.random()*candidates.length)];
  lessonWords.push(next);
  usedLesson[next.w] = true;
}

/* ===== Lesson management ===== */
function newLesson(){
  finished = false;
  passed = {};
  skipped = {};
  usedLesson = {};
  passedCount = 0;
  current = null;
  attempts = 0;
  hintLevel = 0;

  $("celebration").style.display = "none";
  clearConfetti();

  lastLessonWords = [];
  for (var i=0;i<lessonWords.length;i++) lastLessonWords.push(lessonWords[i].w);

  lessonWords = buildNewLessonDifferentFromLast();

  for (var j=0;j<lessonWords.length;j++){
    usedLesson[lessonWords[j].w] = true;
  }

  updateProgress();
  setMsg("Tap <b>Start</b> To Begin.");
}

function remainingWords(){
  var rem = [];
  for (var i=0;i<lessonWords.length;i++){
    var w = lessonWords[i].w;
    if (!passed[w] && !skipped[w]) rem.push(lessonWords[i]);
  }
  return rem;
}

function pickNextWord(){
  if (passedCount >= REQUIRED_CORRECT){
    finishLesson();
    return;
  }
  var rem = remainingWords();
  if (!rem.length){
    finishLesson();
    return;
  }
  current = rem[Math.floor(Math.random()*rem.length)];
  attempts = 0;
  hintLevel = 0;

  $("answer").value = "";
  $("answer").focus();

  setMsg("Listen carefully, then spell the word.");
  speak("Okay Lincoln. The word is " + current.w + ".");
}

/* Start/Next: cannot skip unfinished word */
function startNext(){
  if (finished){
    newLesson();
    pickNextWord();
    return;
  }
  if (!lessonWords.length){
    newLesson();
  }
  if (!current){
    pickNextWord();
    return;
  }

  if (!passed[current.w] && !skipped[current.w]){
    setMsg("Spell the word to move on. You can do it, Lincoln!");
    speak("Spell the word to move on, Lincoln. The word is " + current.w + ".");
    return;
  }

  pickNextWord();
}

function hearAgain(){
  if (!current || finished){
    setMsg("Tap <b>Start</b> To Begin.");
    return;
  }
  speak("The word is " + current.w + ".");
}

function giveHint(){
  if (!current || finished){
    setMsg("Tap <b>Start</b> To Begin.");
    return;
  }

  if (hintLevel === 0){
    setMsg("üí° Hint: Listen slowly.");
    speak("Listen slowly: " + current.w + ".");
  } else if (hintLevel === 1){
    setMsg("üí° Hint: Number of letters.");
    speak("This word has " + current.w.length + " letters.");
  } else {
    setMsg("üí° Hint: Hear it again.");
    speak("The word is " + current.w + ".");
  }

  hintLevel = Math.min(2, hintLevel + 1);
}

function revealAndMoveOn(){
  // Reveal does NOT count as correct
  skipped[current.w] = true;

  // Add replacement so Lincoln can still reach 10 correct
  addReplacementWord();

  // Move on
  pickNextWord();
}

function checkAnswer(){
  if (!current || finished){
    setMsg("Tap <b>Start</b> To Begin.");
    return;
  }

  var ans = normalize($("answer").value);
  if (!ans){
    setMsg("Type (or tap) your answer first.");
    speak("Type your answer first, Lincoln.");
    return;
  }

  var target = normalize(current.w);

  if (ans === target){
    if (!passed[current.w]){
      passed[current.w] = true;
      passedCount++;
      updateProgress();
    }

    var praise = randFrom(PRAISE);
    setMsg("‚úÖ " + praise, "ok");

    speak(praise, function(){
      if (passedCount >= REQUIRED_CORRECT){
        finishLesson();
      } else {
        pickNextWord();
      }
    }, 1000);

  } else {
    attempts++;

    /* #2 & #3: Reveal after 2 tries, show the word, say it once, move on (no sounding out) */
    if (attempts >= 2){
      var correct = current.w;

      setMsg(
        "Nice try, Lincoln.<br>" +
        "The correct spelling is:<br>" +
        "<span style='font-size:44px; font-weight:1000; color:#ffffff; letter-spacing:2px;'>" +
        correct.toUpperCase() +
        "</span>",
        "bad"
      );

      speak("Nice try, Lincoln. The word is " + correct + ".", function(){
        revealAndMoveOn();
      }, 800);

      $("answer").value = "";
      return;
    }

    // First wrong attempt (attempts == 1)
    setMsg("‚ùå Try again, Lincoln.", "bad");
    speak("Try again, Lincoln.");
    $("answer").focus();
  }
}

function clearBox(){
  $("answer").value = "";
  $("answer").focus();
}

function testVoice(){
  setMsg("üîä Testing voice‚Ä¶");
  speak("Hello Lincoln. This is your spelling quest voice.");
}

function finishLesson(){
  finished = true;
  $("celebration").style.display = "flex";
  launchConfetti();
  speak("Great job Lincoln! You finished your lesson!");
  current = null;
}

function playAgain(){
  newLesson();
  pickNextWord();
}

/* ===== Tap keyboard ===== */
var keys = "qwertyuiopasdfghjklzxcvbnm".split("");
function renderKbd(){
  var kbd = $("kbd");
  kbd.innerHTML = "";

  for (var i=0;i<keys.length;i++){
    (function(ch){
      var b = document.createElement("button");
      b.className = "k";
      b.textContent = ch.toUpperCase();
      b.onclick = function(){
        $("answer").value += ch;
        $("answer").focus();
      };
      kbd.appendChild(b);
    })(keys[i]);
  }

  function addWide(label, fn){
    var b = document.createElement("button");
    b.className = "k wider";
    b.textContent = label;
    b.onclick = fn;
    kbd.appendChild(b);
  }

  addWide("‚å´ BACK", function(){
    var v = $("answer").value;
    $("answer").value = v.slice(0,-1);
    $("answer").focus();
  });
  addWide("CLEAR", clearBox);
  addWide("CHECK", checkAnswer);
  addWide("HEAR", hearAgain);
  addWide("HINT", giveHint);
}
renderKbd();

$("answer").addEventListener("keydown", function(e){
  if (e.key === "Enter"){
    e.preventDefault();
    checkAnswer();
  }
});

/* Init */
newLesson();
setTimeout(loadVoices, 500);
setTimeout(loadVoices, 1500);
</script>
</body>
</html>